<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisador de Rótulo Vegetariano</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #374151;
    }
    .container {
      max-width: 90%;
      width: 600px;
      background-color: #ffffff;
      padding: 2.5rem;
      border-radius: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    .file-input {
      display: none;
    }
    .custom-file-upload {
      display: inline-block;
      padding: 12px 24px;
      cursor: pointer;
      border-radius: 0.75rem;
      background-color: #6366f1;
      color: #ffffff;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .custom-file-upload:hover {
      background-color: #4f46e5;
    }
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 0.75rem;
      margin-top: 1.5rem;
      border: 2px dashed #d1d5db;
    }
    .result-container {
      margin-top: 2rem;
      text-align: left;
      border-top: 1px solid #e5e7eb;
      padding-top: 2rem;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="text-3xl md:text-4xl font-extrabold mb-4 text-gray-800">Analisador de Rótulo</h1>
    <p class="text-gray-600 mb-6">Faça o upload de uma imagem do rótulo para descobrir se o produto é vegetariano.</p>
    
    <div class="flex flex-col items-center">
      <label for="file-upload" class="custom-file-upload">
        Escolher Imagem
      </label>
      <input id="file-upload" type="file" accept="image/*" class="file-input" />
    </div>

    <img id="image-preview" class="preview-image hidden mx-auto" src="#" alt="Pré-visualização da imagem" />

    <div id="loading" class="hidden my-4">
      <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
      <p class="text-gray-500 mt-2">Analisando o rótulo...</p>
    </div>

    <div id="results" class="result-container hidden">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Resultado da Análise:</h2>
      <p id="result-text" class="text-gray-700"></p>
    </div>
  </div>

  <script type="module">
    const fileInput = document.getElementById('file-upload');
    const imagePreview = document.getElementById('image-preview');
    const loadingIndicator = document.getElementById('loading');
    const resultsContainer = document.getElementById('results');
    const resultText = document.getElementById('result-text');

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          imagePreview.classList.remove('hidden');
          resultsContainer.classList.add('hidden');
          loadingIndicator.classList.add('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // A plataforma injeta a chave de API automaticamente, por isso a mantemos vazia aqui.
    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    imagePreview.addEventListener('click', () => {
      if (imagePreview.src && !loadingIndicator.classList.contains('hidden')) {
        return; // Prevents multiple clicks during processing
      }
      
      const file = fileInput.files[0];
      if (!file) {
        // Since we are not allowed to use alert, log the message to the console for debugging.
        console.error("Por favor, selecione uma imagem do rótulo primeiro.");
        return;
      }
      
      loadingIndicator.classList.remove('hidden');
      resultsContainer.classList.add('hidden');

      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64Image = e.target.result.split(',')[1];
        const mimeType = file.type;
        
        const systemPrompt = "Você é um especialista em análise de rótulos de alimentos e dietas vegetarianas. Sua tarefa é analisar o rótulo fornecido e determinar se o produto é vegetariano (não contém carne, frango, peixe, frutos do mar ou ingredientes de origem animal como gelatina, colágeno, carmim, cera de abelha, entre outros). Apenas use as informações do rótulo para sua análise. No final da sua resposta, forneça uma conclusão clara: 'O produto É vegetariano.' ou 'O produto NÃO É vegetariano.'";
        
        const userPrompt = "Analise o rótulo de alimentos nesta imagem para determinar se o produto é vegetariano. Liste os ingredientes que você encontrou e sua análise.";
        
        const payload = {
          contents: [{
            parts: [
              { text: userPrompt },
              {
                inlineData: {
                  mimeType: mimeType,
                  data: base64Image
                }
              }
            ]
          }],
          systemInstruction: {
            parts: [{ text: systemPrompt }]
          },
        };

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await response.json();
          const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Não foi possível analisar o rótulo.';

          resultText.innerText = text;
          resultsContainer.classList.remove('hidden');
          loadingIndicator.classList.add('hidden');

        } catch (error) {
          console.error("Erro ao chamar a API:", error);
          resultText.innerText = "Desculpe, ocorreu um erro ao analisar o rótulo. Por favor, tente novamente.";
          loadingIndicator.classList.add('hidden');
          resultsContainer.classList.remove('hidden');
        }
      };
      
      reader.readAsDataURL(file);
    });
  </script>

</body>
</html>
